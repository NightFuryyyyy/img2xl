<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>img2xl</title>
        <link rel="stylesheet" href="./style.css">
    </head>
    <body>
        <input id="image_input" type="file" accept="image/*"><br>
        <canvas id="preview_canvas"></canvas><br>
        <input type="button" value="Export" id="export_button">
        
        <script type="module">
            import ExcelJS from 'https://cdn.skypack.dev/exceljs';

            function componentToHex(c) {
                var hex = c.toString(16);
                return hex.length == 1 ? "0" + hex : hex;
            }

            function pixelToHex(pixel) {
                const a = pixel[3], r = pixel[0], g = pixel[1], b = pixel[2];
                return (componentToHex(a) + componentToHex(r) + componentToHex(g) + componentToHex(b)).toUpperCase();
            }

            function removeExtension(file_name) {
                return file_name.slice(0, file_name.lastIndexOf("."));
            }

            const image_input = document.getElementById("image_input");
            const preview_canvas = document.getElementById("preview_canvas");
            const export_button = document.getElementById("export_button");

            const canvas_context = preview_canvas.getContext("2d");

            image_input.onchange = () => {
                const reader = new FileReader();

                const image_file = image_input.files[0];
                if(!image_file) {
                    alert('Please upload an image.');
                    return;
                }

                reader.onload = event => {
                    const image_object = new Image();

                    image_object.onload = async function() {
                        const workbook = new ExcelJS.Workbook();
                        const worksheet = workbook.addWorksheet('Sheet1');
                        worksheet.properties.defaultColWidth = 1.45;
                        worksheet.properties.defaultRowHeight = 7.5;

                        const canvas_height = 300;
                        const canvas_width = Math.floor((canvas_height / image_object.height) * image_object.width);
                        preview_canvas.height = canvas_height;
                        preview_canvas.width = canvas_width;
                        canvas_context.drawImage(image_object, 0, 0, canvas_width, canvas_height);
                        for (let i = 0; i < canvas_height; i++) {
                            for (let j = 0; j < canvas_width; j++) {
                                const pixel = canvas_context.getImageData(j, i, 1, 1).data;
                                const cell = worksheet.getCell(i + 1, j + 1);
                                cell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: pixelToHex(pixel) }
                                };
                            }
                        }

                        export_button.onclick = async function() {
                            const buffer = await workbook.xlsx.writeBuffer();
                            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = `${removeExtension(image_file.name)}.xlsx`
                            a.click();
                        }
                    };

                    image_object.src = event.target.result;
                };

                reader.readAsDataURL(image_file);
            }
        </script>
    </body>
</html>